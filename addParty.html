<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Party | PHM System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.21.0/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(to right, #1e3c72, #2a5489);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-left h1 {
            color: linear-gradient(to right, #1e3c72, #2a5298);
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header-left p {
            color: #666;
            font-size: 15px;
        }
        
        .header-right {
            text-align: right;
        }
        
        .time-date {
            font-size: 20px;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 8px;
        }
        
        /* Navigation */
        .nav-menu {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .nav-btn.active {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            box-shadow: 0 3px 10px rgba(118, 75, 162, 0.3);
        }
        
        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
        }
        
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        /* Form Card */
        .form-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .card-title {
            font-size: 22px;
            color: #764ba2;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: #667eea;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        .form-control:focus {
            border-color: #667eea;
            outline: none;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #5a6fd8, #6a4290);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }
        
        /* Parties List Card */
        .list-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 15px;
        }
        
        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
        }
        
        .total-parties {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
        }
        
        .parties-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .parties-table th {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .parties-table th:first-child {
            border-top-left-radius: 8px;
        }
        
        .parties-table th:last-child {
            border-top-right-radius: 8px;
        }
        
        .parties-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .parties-table tr:hover {
            background-color: #f9f9ff;
        }
        
        .parties-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .edit-btn {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .edit-btn:hover {
            background: #bbdefb;
            transform: scale(1.1);
        }
        
        .delete-btn {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .delete-btn:hover {
            background: #ffcdd2;
            transform: scale(1.1);
        }
        
        /* Messages */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            display: none;
        }
        
        .alert-success {
            background-color: #e8f7ef;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .alert-error {
            background-color: #ffeaea;
            color: #d32f2f;
            border-left: 4px solid #d32f2f;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header-right {
                text-align: center;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .list-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header, .form-card, .list-card {
                padding: 20px 15px;
            }
            
            .card-title {
                font-size: 20px;
            }
            
            .parties-table th,
            .parties-table td {
                padding: 12px 8px;
                font-size: 14px;
            }
            
            .nav-btn {
                padding: 8px 15px;
                font-size: 14px;
            }
            
            .time-date {
                font-size: 16px;
            }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 50px;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .page-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e1e1e1;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .page-btn.active {
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }
        
        .page-btn:hover:not(.active) {
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-user-friends"></i> Party Management</h1>
                <p>Add, view, update and delete party information</p>
            </div>
            <div class="header-right">
                <div class="time-date" id="currentDateTime">
                    <!-- Real-time clock will be inserted here -->
                </div>
                <div class="nav-menu">
                    <button class="nav-btn" onclick="window.location.href='dashboard.html'">
                        <i class="fas fa-home"></i> Dashboard
                    </button>
                    <button class="nav-btn" onclick="window.location.href='makeEntry.html'">
                        <i class="fas fa-file-invoice"></i> Make Entry
                    </button>
                    <button class="nav-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Add Party Form -->
            <div class="form-card">
                <h2 class="card-title">
                    <i class="fas fa-plus-circle"></i> Add New Party
                </h2>
                
                <div class="alert alert-success" id="successAlert">
                    <i class="fas fa-check-circle"></i>
                    <span id="successMessage">Party added successfully!</span>
                </div>
                
                <div class="alert alert-error" id="errorAlert">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage">Error occurred. Please try again.</span>
                </div>
                
                <form id="partyForm">
                    <input type="hidden" id="partyId" value="">
                    
                    <div class="form-group">
                        <label for="partyName"><i class="fas fa-user-tag"></i> Party Name *</label>
                        <input type="text" id="partyName" class="form-control" 
                               placeholder="Enter party name" required maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="mobileNo"><i class="fas fa-mobile-alt"></i> Mobile Number *</label>
                        <input type="tel" id="mobileNo" class="form-control" 
                               placeholder="Enter 10-digit mobile number">
                    </div>
                    
                    <div class="form-group">
                        <label for="address"><i class="fas fa-map-marker-alt"></i> Address</label>
                        <textarea id="address" class="form-control" 
                                  placeholder="Enter full address" 
                                  rows="3" maxlength="500"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save"></i> <span id="submitText">Save Party</span>
                            <div class="loading-spinner" id="loadingSpinner"></div>
                        </button>
                        <button type="button" class="btn btn-secondary" id="resetBtn">
                            <i class="fas fa-redo"></i> Clear
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Parties List -->
            <div class="list-card">
                <div class="list-header">
                    <h2 class="card-title">
                        <i class="fas fa-list"></i> All Parties
                    </h2>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Search parties...">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="total-parties">
                        <i class="fas fa-users"></i> Total: <span id="totalCount">0</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="parties-table">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Party Name</th>
                                <th width="20%">Mobile No</th>
                                <th width="35%">Address</th>
                                <th width="15%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partiesTableBody">
                            <!-- Parties will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-user-friends"></i>
                    <h3>No Parties Found</h3>
                    <p>Start by adding your first party using the form on the left.</p>
                </div>
                
                <div class="pagination" id="pagination" style="display: none;">
                    <!-- Pagination buttons will be added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        // Supabase Configuration
const supabaseUrl = 'https://iydamvrlxtwsnqvflaxq.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5ZGFtdnJseHR3c25xdmZsYXhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTczMTIsImV4cCI6MjA3MzY3MzMxMn0.Z8m6XGyu9wsN_UJ8EZYr12BRemsO12_U8EEZ9JizQ6w';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// DOM Elements
const currentDateTime = document.getElementById('currentDateTime');
const partyForm = document.getElementById('partyForm');
const partyId = document.getElementById('partyId');
const partyName = document.getElementById('partyName');
const mobileNo = document.getElementById('mobileNo');
const address = document.getElementById('address');
const submitBtn = document.getElementById('submitBtn');
const submitText = document.getElementById('submitText');
const loadingSpinner = document.getElementById('loadingSpinner');
const resetBtn = document.getElementById('resetBtn');
const successAlert = document.getElementById('successAlert');
const errorAlert = document.getElementById('errorAlert');
const successMessage = document.getElementById('successMessage');
const errorMessage = document.getElementById('errorMessage');
const partiesTableBody = document.getElementById('partiesTableBody');
const searchInput = document.getElementById('searchInput');
const totalCount = document.getElementById('totalCount');
const emptyState = document.getElementById('emptyState');
const pagination = document.getElementById('pagination');
const logoutBtn = document.getElementById('logoutBtn');

// State variables
let currentPage = 1;
const itemsPerPage = 10;
let allParties = [];
let filteredParties = [];
let searchTimeout;
let currentSearchTerm = '';

// Initialize real-time clock
function updateDateTime() {
    const now = new Date();
    const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: true 
    };
    
    const dateStr = now.toLocaleDateString('en-US', dateOptions);
    const timeStr = now.toLocaleTimeString('en-US', timeOptions);
    
    currentDateTime.innerHTML = `
        <i class="far fa-calendar-alt"></i> ${dateStr}<br>
        <i class="far fa-clock"></i> ${timeStr}
    `;
}

// Update clock every second
updateDateTime();
setInterval(updateDateTime, 1000);

// Initialize Search Functionality
function initializeSearch() {
    const searchBox = document.querySelector('.search-box');
    
    // Add clear button
    const clearBtn = document.createElement('button');
    clearBtn.innerHTML = '<i class="fas fa-times"></i>';
    clearBtn.className = 'clear-search-btn';
    clearBtn.style.cssText = `
        position: absolute;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        display: none;
        font-size: 16px;
        padding: 5px;
    `;
    
    searchBox.appendChild(clearBtn);
    
    // Clear search functionality
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.focus();
        currentSearchTerm = '';
        filteredParties = [...allParties];
        displayParties();
        this.style.display = 'none';
        updateSearchSummary('');
    });
    
    // Real-time search as user types
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        
        // Show/hide clear button
        clearBtn.style.display = this.value ? 'block' : 'none';
        
        // Show loading indicator
        const searchIcon = searchBox.querySelector('i');
        const originalIcon = searchIcon.className;
        searchIcon.className = 'fas fa-spinner fa-spin';
        
        // Debounce search to avoid too many API calls
        searchTimeout = setTimeout(() => {
            const searchTerm = this.value.trim().toLowerCase();
            currentSearchTerm = searchTerm;
            
            if (!searchTerm) {
                // If search is empty, show all parties
                filteredParties = [...allParties];
                displayParties();
                updateSearchSummary('');
                searchIcon.className = originalIcon;
                return;
            }
            
            // Perform real-time search against party_name
            performRealTimeSearch(searchTerm, originalIcon);
        }, 300); // 300ms delay
    });
}

// Real-time search function with party_name comparison
async function performRealTimeSearch(searchTerm, originalIcon) {
    try {
        // Show loading state in table
        partiesTableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #667eea;"></i>
                    <p style="margin-top: 10px; color: #666;">Searching parties...</p>
                </td>
            </tr>
        `;
        
        // Query Supabase with party_name comparison
        const { data, error } = await supabase
            .from('phmparty')
            .select('*')
            .ilike('party_name', `%${searchTerm}%`)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        // Restore original icon
        const searchIcon = document.querySelector('.search-box i');
        searchIcon.className = originalIcon;
        
        filteredParties = data || [];
        
        // Display with highlight
        displayPartiesWithHighlight(searchTerm);
        
        // Update search summary
        updateSearchSummary(searchTerm);
        
    } catch (error) {
        console.error('Search error:', error);
        partiesTableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px; color: #d32f2f;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p style="margin-top: 10px;">Error searching parties</p>
                </td>
            </tr>
        `;
        
        // Restore original icon
        const searchIcon = document.querySelector('.search-box i');
        searchIcon.className = originalIcon;
    }
}

// Display parties with search term highlighting
function displayPartiesWithHighlight(searchTerm) {
    if (filteredParties.length === 0) {
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <i class="fas fa-search" style="color: #ddd; font-size: 50px; margin-bottom: 15px;"></i>
            <h3>No Parties Found</h3>
            <p>No parties match "${escapeHtml(searchTerm)}"</p>
            <button onclick="clearSearch()" style="
                margin-top: 15px;
                padding: 10px 20px;
                background: linear-gradient(to right, #667eea, #764ba2);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
            ">
                Clear Search
            </button>
        `;
        partiesTableBody.innerHTML = '';
        pagination.style.display = 'none';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Calculate pagination
    const totalPages = Math.ceil(filteredParties.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageParties = filteredParties.slice(startIndex, endIndex);
    
    // Generate table rows with highlight
    let html = '';
    pageParties.forEach((party, index) => {
        const rowNum = startIndex + index + 1;
        const highlightedName = highlightText(party.party_name || '', searchTerm);
        
        html += `
            <tr>
                <td>${rowNum}</td>
                <td>${highlightedName}</td>
                <td>${escapeHtml(party.mobile_no || '')}</td>
                <td>${escapeHtml(party.address || 'N/A')}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editParty('${party.id}')" 
                                title="Edit Party">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteParty('${party.id}')" 
                                title="Delete Party">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    partiesTableBody.innerHTML = html;
    
    // Generate pagination
    if (totalPages > 1) {
        generatePagination(totalPages);
    } else {
        pagination.style.display = 'none';
    }
}

// Highlight search term in text
function highlightText(text, searchTerm) {
    if (!searchTerm || !text) return escapeHtml(text);
    
    const escapedText = escapeHtml(text);
    const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
    return escapedText.replace(regex, '<mark style="background: #fff9c4; padding: 2px; border-radius: 3px;">$1</mark>');
}

// Update search results summary
function updateSearchSummary(searchTerm) {
    const searchSummary = document.querySelector('.search-summary') || createSearchSummary();
    
    if (!searchTerm) {
        searchSummary.innerHTML = `Showing ${filteredParties.length} of ${allParties.length} parties`;
        return;
    }
    
    const matchCount = filteredParties.length;
    const totalCount = allParties.length;
    
    searchSummary.innerHTML = `
        <i class="fas fa-search"></i>
        Found ${matchCount} ${matchCount === 1 ? 'party' : 'parties'} matching "${escapeHtml(searchTerm)}"
        ${matchCount < totalCount ? ` (out of ${totalCount} total)` : ''}
    `;
}

// Create search summary element
function createSearchSummary() {
    const listHeader = document.querySelector('.list-header');
    const searchSummary = document.createElement('div');
    searchSummary.className = 'search-summary';
    searchSummary.style.cssText = `
        width: 100%;
        margin-top: 10px;
        padding: 10px;
        background: #f0f2ff;
        border-radius: 6px;
        font-size: 14px;
        color: #667eea;
        font-weight: 600;
    `;
    
    listHeader.parentNode.insertBefore(searchSummary, listHeader.nextSibling);
    return searchSummary;
}

// Clear search function
function clearSearch() {
    searchInput.value = '';
    currentSearchTerm = '';
    filteredParties = [...allParties];
    displayParties();
    updateSearchSummary('');
    
    // Hide clear button
    const clearBtn = document.querySelector('.clear-search-btn');
    if (clearBtn) clearBtn.style.display = 'none';
}

// Form submission handler
partyForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Validation
    if (!partyName.value.trim()) {
        showError('Please enter party name');
        partyName.focus();
        return;
    }
    
    
    // Show loading state
    submitBtn.disabled = true;
    submitText.textContent = partyId.value ? 'Updating...' : 'Saving...';
    loadingSpinner.style.display = 'block';
    hideAlerts();
    
    try {
        const partyData = {
            party_name: partyName.value.trim(),
            mobile_no: mobileNo.value.trim(),
            address: address.value.trim(),
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        if (partyId.value) {
            // Update existing party
            const { error } = await supabase
                .from('phmparty')
                .update(partyData)
                .eq('id', partyId.value);
            
            if (error) throw error;
            
            showSuccess('Party updated successfully!');
        } else {
            // Insert new party
            const { error } = await supabase
                .from('phmparty')
                .insert([partyData]);
            
            if (error) throw error;
            
            showSuccess('Party added successfully!');
        }
        
        // Reset form and reload parties
        resetForm();
        loadParties();
        
    } catch (error) {
        console.error('Error saving party:', error);
        showError(partyId.value ? 'Failed to update party' : 'Failed to add party');
    } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitText.textContent = partyId.value ? 'Update Party' : 'Save Party';
        loadingSpinner.style.display = 'none';
    }
});

// Load parties from Supabase
async function loadParties() {
    try {
        const { data, error, count } = await supabase
            .from('phmparty')
            .select('*', { count: 'exact' })
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allParties = data || [];
        filteredParties = [...allParties];
        
        // Update total count
        totalCount.textContent = allParties.length;
        
        // Display parties
        displayParties();
        
        // Update search summary
        updateSearchSummary(currentSearchTerm);
        
    } catch (error) {
        console.error('Error loading parties:', error);
        showError('Failed to load parties');
        allParties = [];
        filteredParties = [];
        displayParties();
    }
}

// Display parties in table
function displayParties() {
    if (currentSearchTerm) {
        displayPartiesWithHighlight(currentSearchTerm);
        return;
    }
    
    if (filteredParties.length === 0) {
        emptyState.style.display = 'block';
        partiesTableBody.innerHTML = '';
        pagination.style.display = 'none';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Calculate pagination
    const totalPages = Math.ceil(filteredParties.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageParties = filteredParties.slice(startIndex, endIndex);
    
    // Generate table rows
    let html = '';
    pageParties.forEach((party, index) => {
        const rowNum = startIndex + index + 1;
        html += `
            <tr>
                <td>${rowNum}</td>
                <td>${escapeHtml(party.party_name || '')}</td>
                <td>${escapeHtml(party.mobile_no || '')}</td>
                <td>${escapeHtml(party.address || 'N/A')}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editParty('${party.id}')" 
                                title="Edit Party">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteParty('${party.id}')" 
                                title="Delete Party">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    partiesTableBody.innerHTML = html;
    
    // Generate pagination
    if (totalPages > 1) {
        generatePagination(totalPages);
    } else {
        pagination.style.display = 'none';
    }
}

// Generate pagination buttons
function generatePagination(totalPages) {
    let paginationHtml = '';
    
    // Previous button
    if (currentPage > 1) {
        paginationHtml += `
            <button class="page-btn" onclick="changePage(${currentPage - 1})" title="Previous">
                <i class="fas fa-chevron-left"></i>
            </button>
        `;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            paginationHtml += `
                <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="changePage(${i})">
                    ${i}
                </button>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            paginationHtml += `<span class="page-btn" style="background: none; border: none;">...</span>`;
        }
    }
    
    // Next button
    if (currentPage < totalPages) {
        paginationHtml += `
            <button class="page-btn" onclick="changePage(${currentPage + 1})" title="Next">
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
    }
    
    pagination.innerHTML = paginationHtml;
    pagination.style.display = 'flex';
}

// Edit party function
async function editParty(id) {
    try {
        const { data, error } = await supabase
            .from('phmparty')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        if (data) {
            // Fill form with party data
            partyId.value = data.id;
            partyName.value = data.party_name || '';
            mobileNo.value = data.mobile_no || '';
            address.value = data.address || '';
            
            // Update button text
            submitText.textContent = 'Update Party';
            
            // Scroll to form
            partyName.focus();
            
            showSuccess('Party loaded for editing');
        }
    } catch (error) {
        console.error('Error loading party for edit:', error);
        showError('Failed to load party details');
    }
}

// Delete party function
async function deleteParty(id) {
    if (!confirm('Are you sure you want to delete this party? This action cannot be undone.')) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('phmparty')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
        
        showSuccess('Party deleted successfully!');
        loadParties();
        
    } catch (error) {
        console.error('Error deleting party:', error);
        showError('Failed to delete party');
    }
}

// Change page function
function changePage(page) {
    currentPage = page;
    displayParties();
    // Scroll to top of table
    document.querySelector('.table-container').scrollIntoView({ behavior: 'smooth' });
}

// Reset form function
function resetForm() {
    partyId.value = '';
    partyForm.reset();
    submitText.textContent = 'Save Party';
    hideAlerts();
    localStorage.removeItem('phm_party_draft');
}

// Helper functions
function showSuccess(message) {
    successMessage.textContent = message;
    successAlert.style.display = 'flex';
    errorAlert.style.display = 'none';
    
    // Auto hide after 3 seconds
    setTimeout(() => {
        successAlert.style.display = 'none';
    }, 3000);
}

function showError(message) {
    errorMessage.textContent = message;
    errorAlert.style.display = 'flex';
    successAlert.style.display = 'none';
}

function hideAlerts() {
    successAlert.style.display = 'none';
    errorAlert.style.display = 'none';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Event Listeners
resetBtn.addEventListener('click', resetForm);

logoutBtn.addEventListener('click', function() {
    if (confirm('Are you sure you want to logout?')) {
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = 'index.html';
    }
});

// Mobile number validation
mobileNo.addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
    if (this.value.length > 10) {
        this.value = this.value.slice(0, 10);
    }
});

// Initialize
window.addEventListener('DOMContentLoaded', function() {
    // Check if user is logged in
    const isLoggedIn = sessionStorage.getItem('phm_admin');
    if (!isLoggedIn) {
        alert('Please login first');
        window.location.href = 'index.html';
        return;
    }
    
    // Initialize search functionality
    initializeSearch();
    
    // Load parties
    loadParties();
    
    // Load draft on page load
    const draft = localStorage.getItem('phm_party_draft');
    if (draft && !partyId.value) {
        try {
            const formData = JSON.parse(draft);
            if (confirm('You have unsaved party data. Would you like to restore it?')) {
                partyName.value = formData.party_name || '';
                mobileNo.value = formData.mobile_no || '';
                address.value = formData.address || '';
            } else {
                localStorage.removeItem('phm_party_draft');
            }
        } catch (e) {
            localStorage.removeItem('phm_party_draft');
        }
    }
});

// Auto-save draft
let autoSaveTimer;
const formFields = [partyName, mobileNo, address];

formFields.forEach(field => {
    field.addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            // Save form data to localStorage
            const formData = {
                party_name: partyName.value,
                mobile_no: mobileNo.value,
                address: address.value
            };
            localStorage.setItem('phm_party_draft', JSON.stringify(formData));
        }, 1000);
    });
});

// Clear draft on successful save
partyForm.addEventListener('submit', function() {
    localStorage.removeItem('phm_party_draft');
});

// Export functions for global access
window.clearSearch = clearSearch;
window.editParty = editParty;
window.deleteParty = deleteParty;
window.changePage = changePage;
    </script>
</body>
</html>